---
description: 
globs: 
alwaysApply: true
---
# ğŸš¨ **REGLAS CRÃTICAS PARA TODO EL EQUIPO DELICIA** ğŸš¨

## âš ï¸ **USO OBLIGATORIO DE 5 SERVIDORES MCP + VERIFICACIÃ“N DE DIRECTORIOS**

### ğŸ”§ **CURL MCP - Para Operaciones CRUD**
```
âŒ PROHIBIDO: Usar consola/terminal para operaciones CRUD
âœ… OBLIGATORIO: Usar servidor MCP "curl" para:
- Probar endpoints del backend
- Verificar respuestas de APIs
- Debugging de llamadas HTTP
- Validar integraciones
```

### â° **TIME MCP - Para Fecha y Hora**
```
âœ… OBLIGATORIO: Usar servidor MCP "time" para:
- Documentar tareas completadas con timestamp exacto
- Reportes con fecha/hora actual
- Logging de eventos importantes
- Seguimiento temporal de desarrollo

Ejemplo: [âœ… 2024-01-15 14:30:22] Task 1.1 completada - Setup inicial
```

### ğŸ“š **CONTEXT7 MCP - DocumentaciÃ³n Actualizada**
```
âŒ PROHIBIDO: Asumir conocimiento de librerÃ­as/frameworks
âœ… OBLIGATORIO: Usar servidor MCP "context7" para:
- Consultar documentaciÃ³n actualizada de React, NestJS, Prisma
- Verificar sintaxis correcta antes de implementar
- Obtener mejores prÃ¡cticas actuales
- Resolver dudas tÃ©cnicas especÃ­ficas

NO SE HAGAN LOS LISTOS - SIEMPRE CONSULTEN CONTEXT7
```

### ğŸ§  **MEMORY MCP - CoordinaciÃ³n del Equipo**
```
âœ… OBLIGATORIO: Usar servidor MCP "memory" para:
- ComunicaciÃ³n entre Frontend â†” Backend â†” IA
- Notas rÃ¡pidas pero importantes
- Mensajes para otros miembros del equipo
- CoordinaciÃ³n de dependencias

ESTRUCTURA DE ENTIDADES:
- Entidad "Frontend" - mensajes para desarrollador frontend
- Entidad "Backend" - mensajes para desarrollador backend  
- Entidad "IA" - mensajes para desarrollador IA
- Entidad "General" - notas del proyecto general

Ejemplo: "Necesito que Backend complete Task 2.1 antes de integrar login"
```

### ğŸ—„ï¸ **POSTGRES MCP - Base de Datos Directa**
```
âœ… OBLIGATORIO: Usar servidor MCP "postgres" para:
- Consultas directas a la base de datos cuando sea necesario
- Verificar datos durante desarrollo
- Debugging de problemas de datos
- Operaciones manuales urgentes

âš ï¸ IMPORTANTE: La base de datos se mantiene con migraciones Prisma
âŒ NO usar para cambios de schema - usar Prisma migrate
âœ… SÃ usar para consultas, verificaciones y operaciones manuales

Ejemplo: Verificar si un pedido se creÃ³ correctamente o consultar datos especÃ­ficos
```

### ğŸ’» **EJECUCIÃ“N DE COMANDOS - DIRECTORIOS CRÃTICOS**
```
ğŸš¨ CRÃTICO: VERIFICAR DIRECTORIO ANTES DE EJECUTAR COMANDOS

ESTRUCTURA DEL PROYECTO:
DelicIA/
â”œâ”€â”€ frontend/          â† AquÃ­ ejecutar comandos de React/Vite
â”œâ”€â”€ backend/           â† AquÃ­ ejecutar comandos de NestJS/Prisma  
â””â”€â”€ [otros archivos]

âš ï¸ ANTES DE EJECUTAR CUALQUIER COMANDO:
1. pwd / Get-Location - Verificar directorio actual
2. Cambiar al directorio correcto si es necesario
3. NUNCA ejecutar comandos desde directorio incorrecto

COMANDOS POR DIRECTORIO:

ğŸ“ FRONTEND (DelicIA/frontend/):
âœ… npm run dev          - Levantar servidor desarrollo
âœ… npm run build        - Build de producciÃ³n
âœ… npm install [pkg]    - Instalar dependencias React
âœ… npx shadcn add [comp] - Agregar componentes ShadCN

ğŸ“ BACKEND (DelicIA/backend/):
âœ… npm run start:dev    - Levantar servidor NestJS
âœ… npm run build        - Build de producciÃ³n
âœ… npx prisma migrate dev - Ejecutar migraciones
âœ… npx prisma generate  - Generar cliente Prisma
âœ… npm install [pkg]    - Instalar dependencias NestJS

âŒ ERRORES COMUNES A EVITAR:
- Ejecutar 'npm run dev' desde DelicIA/ (directorio raÃ­z)
- Ejecutar comandos de Prisma desde frontend/
- Ejecutar comandos de React desde backend/
- No verificar directorio antes de instalar dependencias

ğŸ”§ COMANDOS DE VERIFICACIÃ“N:
Windows: Get-Location o pwd
Linux/Mac: pwd
```

---

# Backend NestJS Rules - Delicia

## ğŸ—ï¸ Arquitectura Modular

### Estructura de MÃ³dulos
```typescript
// âœ… Estructura recomendada
modules/
  auth/
    â”œâ”€â”€ auth.module.ts
    â”œâ”€â”€ auth.controller.ts
    â”œâ”€â”€ auth.service.ts
    â”œâ”€â”€ dto/
    â”‚   â”œâ”€â”€ login.dto.ts
    â”‚   â””â”€â”€ register.dto.ts
    â”œâ”€â”€ guards/
    â””â”€â”€ strategies/
```

### Decorators Apropiados
```typescript
// âœ… Usar decorators correctos
@Injectable()
export class AuthService {}

@Controller('auth')
export class AuthController {}

@UseGuards(JwtAuthGuard)
@Get('profile')
async getProfile() {}
```

## ğŸ—„ï¸ Prisma y Base de Datos

### Queries Optimizadas
```typescript
// âœ… Usar select/include apropiados
const booking = await this.prisma.booking.findUnique({
  where: { id },
  select: {
    id: true,
    totalAmount: true,
    tour: {
      select: {
        id: true,
        title: true
      }
    }
  }
});

// âœ… Eager loading para reducir N+1 queries
const tours = await this.prisma.tour.findMany({
  include: {
    destinations: true,
    departureDates: true
  }
});
```

### Transacciones para Operaciones CrÃ­ticas
```typescript
// âœ… Usar transacciones para operaciones atÃ³micas
const result = await this.prisma.$transaction(async (tx) => {
  const booking = await tx.booking.create({
    data: bookingData
  });
  
  await tx.departureDate.update({
    where: { id: departureDateId },
    data: {
      availableSpots: {
        decrement: passengers.length
      }
    }
  });
  
  return booking;
});
```

### Migraciones
```bash
# âœ… Comandos para migraciones
npx prisma migrate dev --name descriptive_migration_name
npx prisma generate
npx prisma db push # Solo para desarrollo
```

## ğŸ” ValidaciÃ³n con class-validator

### DTOs con ValidaciÃ³n
```typescript
// âœ… DTOs robustos con validaciÃ³n
export class CreateBookingDto {
  @IsUUID()
  @IsNotEmpty()
  tourId: string;

  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => PassengerDto)
  passengers: PassengerDto[];

  @IsOptional()
  @IsString()
  @MaxLength(500)
  specialRequests?: string;

  @IsNumber()
  @IsPositive()
  totalAmount: number;
}
```

### Pipes de ValidaciÃ³n
```typescript
// âœ… Usar ValidationPipe globalmente
app.useGlobalPipes(new ValidationPipe({
  whitelist: true,
  forbidNonWhitelisted: true,
  transform: true,
  transformOptions: {
    enableImplicitConversion: true
  }
}));
```

## âš ï¸ Manejo de Errores

### Exception Filters Personalizados
```typescript
// âœ… Filters de excepciÃ³n estructurados
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const status = exception.getStatus();

    response.status(status).json({
      statusCode: status,
      message: exception.message,
      timestamp: new Date().toISOString(),
    });
  }
}
```

### Logging Estructurado
```typescript
// âœ… Logging con contexto
@Injectable()
export class BookingsService {
  private readonly logger = new Logger(BookingsService.name);

  async create(createBookingDto: CreateBookingDto) {
    this.logger.log(`Creating booking for tour ${createBookingDto.tourId}`);
    
    try {
      // lÃ³gica del servicio
      this.logger.log(`Booking created successfully: ${result.id}`);
      return result;
    } catch (error) {
      this.logger.error(`Failed to create booking: ${error.message}`, error.stack);
      throw error;
    }
  }
}
```

## ğŸ” Guards y Middleware

### Guards de AutenticaciÃ³n
```typescript
// âœ… Guards apropiados
@UseGuards(JwtAuthGuard)
@UseGuards(RolesGuard)
@Roles('admin')
@Get('admin/bookings')
async getAdminBookings() {}
```

### Rate Limiting
```typescript
// âœ… Rate limiting para endpoints sensibles
@UseGuards(ThrottlerGuard)
@Throttle(5, 60) // 5 requests por minuto
@Post('login')
async login() {}
```

## ğŸ“Š Performance y OptimizaciÃ³n

### Caching
```typescript
// âœ… Cache para datos frecuentes
@Injectable()
export class ToursService {
  @Cacheable('tours', 300) // 5 minutos
  async findAll() {
    return this.prisma.tour.findMany();
  }
}
```

### PaginaciÃ³n
```typescript
// âœ… PaginaciÃ³n server-side
async findMany(page: number = 1, limit: number = 10) {
  const skip = (page - 1) * limit;
  
  const [data, total] = await Promise.all([
    this.prisma.tour.findMany({
      skip,
      take: limit,
      orderBy: { createdAt: 'desc' }
    }),
    this.prisma.tour.count()
  ]);
  
  return {
    data,
    meta: {
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit)
    }
  };
}
```

## ğŸ›¡ï¸ Seguridad

### SanitizaciÃ³n de Entrada
```typescript
// âœ… Sanitizar y validar entradas
@Post()
async create(
  @Body(new ValidationPipe({ transform: true, whitelist: true }))
  createDto: CreateTourDto
) {
  // Los datos ya estÃ¡n validados y sanitizados
  return this.service.create(createDto);
}
```

### Headers de Seguridad
```typescript
// âœ… Configurar headers de seguridad
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"]
    }
  }
}));
```

## ğŸ“‹ Checklist Backend

- [ ] MÃ³dulos organizados por feature
- [ ] DTOs con validaciÃ³n class-validator
- [ ] Queries Prisma optimizadas
- [ ] Transacciones para operaciones crÃ­ticas
- [ ] Exception filters implementados
- [ ] Logging estructurado
- [ ] Guards de autenticaciÃ³n y autorizaciÃ³n
- [ ] Rate limiting en endpoints sensibles
- [ ] PaginaciÃ³n server-side
- [ ] Caching para datos frecuentes
- [ ] Headers de seguridad configurados

## â›” Anti-patrones Backend

- Queries N+1 sin optimizar
- Operaciones sin transacciones
- DTOs sin validaciÃ³n
- Hardcodear valores de configuraciÃ³n
- Ignorar manejo de errores
- Logs sin contexto
- Endpoints sin rate limiting
- Datos sensibles en logs

## ğŸš¨ **RECORDATORIO FINAL MCP**

**ANTES DE CUALQUIER IMPLEMENTACIÃ“N:**
1. â° Consultar TIME para timestamp actual
2. ğŸ“š Consultar CONTEXT7 para documentaciÃ³n actualizada  
3. ğŸ§  Revisar MEMORY para mensajes del equipo
4. ğŸ”§ Usar CURL para probar funcionalidad
5. ğŸ—„ï¸ Usar POSTGRES para consultas directas cuando sea necesario
6. ğŸ’» VERIFICAR DIRECTORIO antes de ejecutar comandos

**Â¡NO EXCEPCIONES! ESTOS 6 PUNTOS SON OBLIGATORIOS** ğŸš¨
